###############################################################################
# üõ† BUILD STAGE ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–ª—ë—Å–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
###############################################################################
FROM python:3.11-alpine AS builder

# 1) –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ C-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–µ—Å–ª–∏ –≤ requirements –µ—Å—Ç—å —Ç–∞–∫–∏–µ –ø–∞–∫–µ—Ç—ã)
RUN apk add --no-cache \
      build-base \
      libffi-dev \
      openssl-dev \
      python3-dev

WORKDIR /wheels

# 2) —Å–æ–±–∏—Ä–∞–µ–º .whl –¥–ª—è –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –≤–∫–ª—é—á–∞—è OpenTelemetry
COPY requirements.txt .
RUN pip wheel --no-cache-dir --wheel-dir=/wheels -r requirements.txt \
 && pip wheel --no-cache-dir --wheel-dir=/wheels \
      opentelemetry-distro \
      opentelemetry-exporter-jaeger

###############################################################################
# üöÄ RUNTIME STAGE ‚Äî —Ç–æ–ª—å–∫–æ runtime-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∫–æ–¥
###############################################################################
FROM python:3.11-alpine AS runtime

# 3) —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ C-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
RUN apk add --no-cache libffi openssl

WORKDIR /app

# 4) —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–ª—ë—Å
COPY --from=builder /wheels /wheels
RUN pip install --no-index --no-cache-dir /wheels/*.whl \
 && rm -rf /wheels

# 5) –∫–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY . .

# 6) –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è OpenTelemetry
ENV OTEL_SERVICE_NAME=mission-handler \
    OTEL_EXPORTER_JAEGER_ENDPOINT=http://jaeger-collector.observability:14268/api/traces

# 7) –ø–æ—Ä—Ç –∏ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
EXPOSE 5006
CMD ["opentelemetry-instrument", \
     "--traces_exporter","jaeger", \
     "--service_name","mission-handler", \
     "python","app.py"]